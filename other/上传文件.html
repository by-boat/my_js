<html>
  <head>
    <meta charset="UTF-8" />
    <title>XMLHttpRequestä¸Šä¼ æ–‡ä»¶</title>
    <script type="text/javascript">
      //å›¾ç‰‡ä¸Šä¼ 
      var xhr;
      //ä¸Šä¼ æ–‡ä»¶æ–¹æ³•
      function UpladFile() {
        var fileObj = document.getElementById("file").files[0]; // js è·å–æ–‡ä»¶å¯¹è±¡
        console.log("ğŸš€ ~ file: ä¸Šä¼ æ–‡ä»¶.html ~ line 11 ~ UpladFile ~ fileObj", fileObj)
        // var url = "http://localhost:8080" + "/api/attachment/upload"; // æ¥æ”¶ä¸Šä¼ æ–‡ä»¶çš„åå°åœ°å€
        var url = "http://localhost:2022/api/user/file"

        var form = new FormData(); // FormData å¯¹è±¡
        form.append("file", fileObj); // æ–‡ä»¶å¯¹è±¡
        console.log("ğŸš€ ~ file: ä¸Šä¼ æ–‡ä»¶.html ~ line 17 ~ UpladFile ~ form", form)

        xhr = new XMLHttpRequest(); // XMLHttpRequest å¯¹è±¡
        xhr.open("post", url, true); //postæ–¹å¼ï¼Œurlä¸ºæœåŠ¡å™¨è¯·æ±‚åœ°å€ï¼Œtrue è¯¥å‚æ•°è§„å®šè¯·æ±‚æ˜¯å¦å¼‚æ­¥å¤„ç†ã€‚
        xhr.onload = uploadComplete; //è¯·æ±‚å®Œæˆ
        xhr.onerror = uploadFailed; //è¯·æ±‚å¤±è´¥

        xhr.upload.onprogress = progressFunction; //ã€ä¸Šä¼ è¿›åº¦è°ƒç”¨æ–¹æ³•å®ç°ã€‘
        xhr.upload.onloadstart = function () {
          //ä¸Šä¼ å¼€å§‹æ‰§è¡Œæ–¹æ³•
          ot = new Date().getTime(); //è®¾ç½®ä¸Šä¼ å¼€å§‹æ—¶é—´
          oloaded = 0; //è®¾ç½®ä¸Šä¼ å¼€å§‹æ—¶ï¼Œä»¥ä¸Šä¼ çš„æ–‡ä»¶å¤§å°ä¸º0
        };

        xhr.send(form); //å¼€å§‹ä¸Šä¼ ï¼Œå‘é€formæ•°æ®
      }

      //ä¸Šä¼ æˆåŠŸå“åº”
      function uploadComplete(evt) {
        //æœåŠ¡æ–­æ¥æ”¶å®Œæ–‡ä»¶è¿”å›çš„ç»“æœ

        var data = JSON.parse(evt.target.responseText);
        if (data.success) {
          alert("ä¸Šä¼ æˆåŠŸï¼");
        } else {
          alert("ä¸Šä¼ å¤±è´¥ï¼");
        }
      }
      //ä¸Šä¼ å¤±è´¥
      function uploadFailed(evt) {
        alert("ä¸Šä¼ å¤±è´¥ï¼");
      }
      //å–æ¶ˆä¸Šä¼ 
      function cancleUploadFile() {
        xhr.abort();
      }

      //ä¸Šä¼ è¿›åº¦å®ç°æ–¹æ³•ï¼Œä¸Šä¼ è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹è°ƒç”¨è¯¥æ–¹æ³•
      function progressFunction(evt) {
        var progressBar = document.getElementById("progressBar");
        var percentageDiv = document.getElementById("percentage");
        // event.totalæ˜¯éœ€è¦ä¼ è¾“çš„æ€»å­—èŠ‚ï¼Œevent.loadedæ˜¯å·²ç»ä¼ è¾“çš„å­—èŠ‚ã€‚å¦‚æœevent.lengthComputableä¸ä¸ºçœŸï¼Œåˆ™event.totalç­‰äº0
        if (evt.lengthComputable) {
          //
          progressBar.max = evt.total;
          progressBar.value = evt.loaded;
          percentageDiv.innerHTML =
            Math.round((evt.loaded / evt.total) * 100) + "%";
        }
        var time = document.getElementById("time");
        var nt = new Date().getTime(); //è·å–å½“å‰æ—¶é—´
        var pertime = (nt - ot) / 1000; //è®¡ç®—å‡ºä¸Šæ¬¡è°ƒç”¨è¯¥æ–¹æ³•æ—¶åˆ°ç°åœ¨çš„æ—¶é—´å·®ï¼Œå•ä½ä¸ºs
        ot = new Date().getTime(); //é‡æ–°èµ‹å€¼æ—¶é—´ï¼Œç”¨äºä¸‹æ¬¡è®¡ç®—
        var perload = evt.loaded - oloaded; //è®¡ç®—è¯¥åˆ†æ®µä¸Šä¼ çš„æ–‡ä»¶å¤§å°ï¼Œå•ä½b
        oloaded = evt.loaded; //é‡æ–°èµ‹å€¼å·²ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼Œç”¨ä»¥ä¸‹æ¬¡è®¡ç®—
        //ä¸Šä¼ é€Ÿåº¦è®¡ç®—
        var speed = perload / pertime; //å•ä½b/s
        var bspeed = speed;
        var units = "b/s"; //å•ä½åç§°
        if (speed / 1024 > 1) {
          speed = speed / 1024;
          units = "k/s";
        }
        if (speed / 1024 > 1) {
          speed = speed / 1024;
          units = "M/s";
        }
        speed = speed.toFixed(1);
        //å‰©ä½™æ—¶é—´
        var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
        time.innerHTML =
          "ï¼Œé€Ÿåº¦ï¼š" + speed + units + "ï¼Œå‰©ä½™æ—¶é—´ï¼š" + resttime + "s";
        if (bspeed == 0) time.innerHTML = "ä¸Šä¼ å·²å–æ¶ˆ";
      }
    </script>
  </head>
  <body>
    <progress
      id="progressBar"
      value="0"
      max="100"
      style="width: 300px"
    ></progress>
    <span id="percentage"></span><span id="time"></span> <br /><br />
    <input type="file" id="file" name="myfile" />
    <input type="button" onclick="UpladFile()" value="ä¸Šä¼ " />
    <input type="button" onclick="cancleUploadFile()" value="å–æ¶ˆ" />
  </body>
</html>
